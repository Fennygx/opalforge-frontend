<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpalForge Model Diagnostics</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #1a1a1a;
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #00ff00;
        }
        .section {
            background: #0f0f0f;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .section h2 {
            color: #ffaa00;
            margin-bottom: 15px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #00cc00;
            box-shadow: 0 0 15px #00ff00;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            background: #ffaa00;
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .file-label:hover {
            background: #ff8800;
        }
        #output {
            background: #000;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .status.success { background: #00ff00; color: #000; }
        .status.error { background: #ff0000; color: #fff; }
        .status.warning { background: #ffaa00; color: #000; }
        .status.info { background: #00aaff; color: #000; }
        img {
            max-width: 300px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            margin: 10px 0;
        }
        .prediction-box {
            background: #0a0a0a;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #00ff00;
        }
        .confidence-bar {
            background: #333;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffaa00, #00ff00);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ OPALFORGE MODEL DIAGNOSTICS</h1>
        
        <div class="section">
            <h2>1. Model Loading Test</h2>
            <button id="loadModelBtn">Load Model</button>
            <button id="inspectModelBtn" disabled>Inspect Model Structure</button>
            <div id="modelStatus"></div>
        </div>

        <div class="section">
            <h2>2. Image Analysis</h2>
            <label class="file-label" for="imageInput">
                üìÅ Select Test Image
            </label>
            <input type="file" id="imageInput" accept="image/*">
            <div id="imagePreview"></div>
            <button id="analyzeBtn" disabled>üîç Analyze Image</button>
            <div id="analysisResults"></div>
        </div>

        <div class="section">
            <h2>3. Diagnostic Output</h2>
            <button id="clearLog">Clear Log</button>
            <button id="exportLog">Export Log</button>
            <div id="output"></div>
        </div>
    </div>

    <script>
        let model = null;
        let currentImage = null;
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type;
            const line = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = `status ${statusClass}`;
            span.textContent = line;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        // Load Model
        document.getElementById('loadModelBtn').addEventListener('click', async () => {
            const btn = document.getElementById('loadModelBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                log('Starting model load...', 'info');
                
                // Clear any existing model
                if (model) {
                    model.dispose();
                    await tf.disposeVariables();
                    log('Cleared previous model from memory', 'warning');
                }

                // Load model
                model = await tf.loadLayersModel('./model/model.json');
                
                log('‚úÖ MODEL LOADED SUCCESSFULLY', 'success');
                
                // Display model info
                document.getElementById('modelStatus').innerHTML = `
                    <div class="prediction-box">
                        <strong>Model Name:</strong> LuxVerify<br>
                        <strong>Input Shape:</strong> [null, 224, 224, 3]<br>
                        <strong>Output Classes:</strong> 2<br>
                        <strong>Labels:</strong><br>
                        - Class 0: Verified Authentic<br>
                        - Class 1: Verified Replica / Counterfeit
                    </div>
                `;
                
                document.getElementById('inspectModelBtn').disabled = false;
                document.getElementById('analyzeBtn').disabled = false;
                
            } catch (error) {
                log(`‚ùå MODEL LOAD FAILED: ${error.message}`, 'error');
                document.getElementById('modelStatus').innerHTML = 
                    `<span class="status error">Error: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reload Model';
            }
        });

        // Inspect Model
        document.getElementById('inspectModelBtn').addEventListener('click', () => {
            if (!model) return;
            
            log('=== MODEL INSPECTION ===', 'info');
            log(`Total Layers: ${model.layers.length}`, 'info');
            
            // Check input layer
            const inputShape = model.inputs[0].shape;
            log(`Input Shape: ${JSON.stringify(inputShape)}`, 'info');
            
            // Check output layer
            const outputShape = model.outputs[0].shape;
            log(`Output Shape: ${JSON.stringify(outputShape)}`, 'info');
            
            // Summary
            model.summary();
            log('Model summary printed to console', 'success');
        });

        // Image Upload
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                currentImage = new Image();
                currentImage.src = event.target.result;
                currentImage.onload = () => {
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('imagePreview').appendChild(currentImage);
                    log(`Image loaded: ${file.name} (${currentImage.width}x${currentImage.height})`, 'success');
                };
            };
            reader.readAsDataURL(file);
        });

        // Analyze Image
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!model || !currentImage) {
                log('Please load model and select image first', 'error');
                return;
            }

            log('\n=== STARTING ANALYSIS ===', 'info');
            
            try {
                const result = await tf.tidy(() => {
                    // Step 1: Convert to tensor
                    log('Step 1: Converting image to tensor...', 'info');
                    let tensor = tf.browser.fromPixels(currentImage);
                    log(`Tensor shape: ${tensor.shape}`, 'info');
                    
                    // Step 2: Handle alpha channel
                    if (tensor.shape[2] === 4) {
                        log('Step 2: Removing alpha channel (RGBA ‚Üí RGB)', 'warning');
                        tensor = tensor.slice([0, 0, 0], [-1, -1, 3]);
                    } else {
                        log('Step 2: Image is already RGB', 'success');
                    }
                    
                    // Step 3: Resize
                    log('Step 3: Resizing to 224x224...', 'info');
                    const resized = tf.image.resizeBilinear(tensor, [224, 224]);
                    log(`Resized shape: ${resized.shape}`, 'info');
                    
                    // Step 4: Normalize
                    log('Step 4: Normalizing to [0, 1]...', 'info');
                    const normalized = resized.toFloat().div(255.0);
                    
                    // Check pixel values
                    const pixels = normalized.arraySync();
                    const samplePixel = pixels[0][0];
                    log(`Sample pixel RGB: [${samplePixel[0].toFixed(3)}, ${samplePixel[1].toFixed(3)}, ${samplePixel[2].toFixed(3)}]`, 'info');
                    
                    // Step 5: Add batch dimension
                    log('Step 5: Adding batch dimension...', 'info');
                    const batched = normalized.expandDims(0);
                    log(`Batched shape: ${batched.shape}`, 'info');
                    
                    // Step 6: Predict
                    log('Step 6: Running prediction...', 'info');
                    const prediction = model.predict(batched);
                    const predArray = prediction.arraySync()[0];
                    
                    log(`Raw prediction output: ${JSON.stringify(predArray)}`, 'warning');
                    
                    return {
                        authenticProb: predArray[0],
                        replicaProb: predArray[1],
                        prediction: predArray
                    };
                });

                // Display results
                log('\n=== PREDICTION RESULTS ===', 'success');
                log(`Class 0 (Authentic): ${(result.authenticProb * 100).toFixed(2)}%`, 'info');
                log(`Class 1 (Replica): ${(result.replicaProb * 100).toFixed(2)}%`, 'info');
                
                const confidence = Math.max(result.authenticProb, result.replicaProb) * 100;
                const isAuthentic = result.authenticProb > result.replicaProb;
                
                log(`\nFINAL: ${isAuthentic ? '‚úÖ AUTHENTIC' : '‚ùå REPLICA'} (${confidence.toFixed(1)}% confidence)`, 
                    isAuthentic ? 'success' : 'error');

                // Visual display
                document.getElementById('analysisResults').innerHTML = `
                    <div class="prediction-box">
                        <h3>${isAuthentic ? '‚úÖ VERIFIED AUTHENTIC' : '‚ùå REPLICA DETECTED'}</h3>
                        <p><strong>Confidence:</strong> ${confidence.toFixed(1)}%</p>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%">
                                ${confidence.toFixed(1)}%
                            </div>
                        </div>
                        <p><strong>Raw Scores:</strong></p>
                        <p>Authentic: ${(result.authenticProb * 100).toFixed(2)}%</p>
                        <p>Replica: ${(result.replicaProb * 100).toFixed(2)}%</p>
                    </div>
                `;

            } catch (error) {
                log(`‚ùå ANALYSIS FAILED: ${error.message}`, 'error');
                console.error(error);
            }
        });

        // Clear Log
        document.getElementById('clearLog').addEventListener('click', () => {
            output.innerHTML = '';
        });

        // Export Log
        document.getElementById('exportLog').addEventListener('click', () => {
            const logText = output.innerText;
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `opalforge-diagnostic-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Log exported', 'success');
        });

        // Auto-load on startup
        log('Diagnostic tool ready. Click "Load Model" to begin.', 'info');
    </script>
</body>
</html>
