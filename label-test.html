<!-- ============================================ -->
<!-- INVERSION DETECTION TEST TOOL               -->
<!-- Tests if Teachable Machine labels are flipped -->
<!-- ============================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Inversion Test - OpalForge</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: 600;
            transition: all 0.3s;
        }
        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .image-item .label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }
        .prediction {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        .authentic { color: #28a745; }
        .replica { color: #dc3545; }
        .scores {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .score-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .score-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .score-label {
            color: #6c757d;
            font-size: 14px;
        }
        .conclusion {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .conclusion h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .conclusion p {
            color: #856404;
            line-height: 1.6;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px 0;
        }
        .status.loading { background: #17a2b8; color: white; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Label Inversion Test</h1>
        <p class="subtitle">This tool will determine if your Teachable Machine training labels are inverted</p>

        <!-- Step 1: Load Model -->
        <div class="test-section">
            <h2>Step 1: Load Your Model</h2>
            <button id="loadModel">Load Model from ./model/</button>
            <div id="modelStatus"></div>
        </div>

        <!-- Step 2: Upload Known Images -->
        <div class="test-section" id="uploadSection" style="display:none;">
            <h2>Step 2: Upload Test Images</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Upload images that YOU KNOW are authentic or replica. The more certain you are, the better the test.
            </p>
            
            <div style="margin: 20px 0;">
                <label class="file-label" for="authenticInput">
                    ‚úÖ Upload AUTHENTIC Sneakers
                </label>
                <input type="file" id="authenticInput" class="file-input" accept="image/*" multiple>
            </div>

            <div style="margin: 20px 0;">
                <label class="file-label" for="replicaInput" style="background: #dc3545;">
                    ‚ùå Upload REPLICA Sneakers
                </label>
                <input type="file" id="replicaInput" class="file-input" accept="image/*" multiple>
            </div>

            <div class="image-grid" id="imageGrid"></div>

            <button id="runTest" style="background: #ffc107; color: #000; font-size: 18px; padding: 15px 40px;">
                üöÄ Run Inversion Test
            </button>
        </div>

        <!-- Step 3: Results -->
        <div class="test-section" id="resultsSection" style="display:none;">
            <h2>Step 3: Test Results</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <div id="results"></div>
        </div>

        <!-- Conclusion -->
        <div id="conclusionSection" style="display:none;">
        </div>
    </div>

    <script>
        let model = null;
        let authenticImages = [];
        let replicaImages = [];

        // Load Model
        document.getElementById('loadModel').addEventListener('click', async () => {
            const btn = document.getElementById('loadModel');
            const status = document.getElementById('modelStatus');
            
            btn.disabled = true;
            btn.textContent = 'Loading...';
            status.innerHTML = '<span class="status loading">Loading model...</span>';

            try {
                model = await tf.loadLayersModel('./model/model.json');
                status.innerHTML = '<span class="status success">‚úÖ Model loaded successfully!</span>';
                document.getElementById('uploadSection').style.display = 'block';
            } catch (error) {
                status.innerHTML = `<span class="status error">‚ùå Error: ${error.message}</span>`;
                btn.disabled = false;
                btn.textContent = 'Retry Load';
            }
        });

        // Handle Authentic Images
        document.getElementById('authenticInput').addEventListener('change', (e) => {
            handleImageUpload(e.files, 'authentic');
        });

        // Handle Replica Images
        document.getElementById('replicaInput').addEventListener('change', (e) => {
            handleImageUpload(e.files, 'replica');
        });

        function handleImageUpload(files, type) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const item = { img, type, name: file.name };
                        
                        if (type === 'authentic') {
                            authenticImages.push(item);
                        } else {
                            replicaImages.push(item);
                        }
                        
                        updateImageGrid();
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImageGrid() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            const allImages = [...authenticImages, ...replicaImages];
            
            allImages.forEach(item => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.innerHTML = `
                    <img src="${item.img.src}">
                    <div class="label">${item.type === 'authentic' ? '‚úÖ AUTHENTIC' : '‚ùå REPLICA'}</div>
                    <div style="font-size: 12px; color: #6c757d;">${item.name}</div>
                `;
                grid.appendChild(div);
            });
        }

        // Run Test
        document.getElementById('runTest').addEventListener('click', async () => {
            if (authenticImages.length === 0 || replicaImages.length === 0) {
                alert('Please upload at least one authentic AND one replica image!');
                return;
            }

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('runTest').disabled = true;

            const results = {
                authentic: [],
                replica: []
            };

            let progress = 0;
            const totalImages = authenticImages.length + replicaImages.length;

            // Test authentic images
            for (const item of authenticImages) {
                const prediction = await predictImage(item.img);
                results.authentic.push(prediction);
                progress++;
                updateProgress((progress / totalImages) * 100);
            }

            // Test replica images
            for (const item of replicaImages) {
                const prediction = await predictImage(item.img);
                results.replica.push(prediction);
                progress++;
                updateProgress((progress / totalImages) * 100);
            }

            analyzeResults(results);
        });

        async function predictImage(img) {
            return await tf.tidy(() => {
                let tensor = tf.browser.fromPixels(img);
                
                if (tensor.shape[2] === 4) {
                    tensor = tensor.slice([0, 0, 0], [-1, -1, 3]);
                }
                
                const resized = tf.image.resizeBilinear(tensor, [224, 224]);
                const normalized = resized.toFloat().div(255.0);
                const batched = normalized.expandDims(0);
                
                const prediction = model.predict(batched);
                const scores = prediction.arraySync()[0];
                
                return {
                    authenticScore: scores[0],
                    replicaScore: scores[1],
                    predictedAsAuthentic: scores[0] > scores[1]
                };
            });
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function analyzeResults(results) {
            const resultsDiv = document.getElementById('results');
            
            // Calculate accuracy for both scenarios
            let correctIfNormal = 0;
            let correctIfInverted = 0;
            const totalTests = results.authentic.length + results.replica.length;

            // Scenario 1: Labels are CORRECT (authentic = index 0)
            results.authentic.forEach(pred => {
                if (pred.predictedAsAuthentic) correctIfNormal++;
            });
            results.replica.forEach(pred => {
                if (!pred.predictedAsAuthentic) correctIfNormal++;
            });

            // Scenario 2: Labels are INVERTED (authentic = index 1)
            results.authentic.forEach(pred => {
                if (!pred.predictedAsAuthentic) correctIfInverted++;
            });
            results.replica.forEach(pred => {
                if (pred.predictedAsAuthentic) correctIfInverted++;
            });

            const normalAccuracy = (correctIfNormal / totalTests) * 100;
            const invertedAccuracy = (correctIfInverted / totalTests) * 100;

            // Display detailed results
            resultsDiv.innerHTML = `
                <div class="scores">
                    <div class="score-card">
                        <div class="score-label">If Labels Are CORRECT</div>
                        <div class="score-value" style="color: ${normalAccuracy > invertedAccuracy ? '#28a745' : '#6c757d'}">
                            ${normalAccuracy.toFixed(0)}%
                        </div>
                        <div class="score-label">${correctIfNormal}/${totalTests} correct predictions</div>
                    </div>
                    <div class="score-card">
                        <div class="score-label">If Labels Are INVERTED</div>
                        <div class="score-value" style="color: ${invertedAccuracy > normalAccuracy ? '#28a745' : '#6c757d'}">
                            ${invertedAccuracy.toFixed(0)}%
                        </div>
                        <div class="score-label">${correctIfInverted}/${totalTests} correct predictions</div>
                    </div>
                </div>
            `;

            // Show conclusion
            const conclusionDiv = document.getElementById('conclusionSection');
            conclusionDiv.style.display = 'block';

            const isInverted = invertedAccuracy > normalAccuracy;
            const confidence = Math.abs(invertedAccuracy - normalAccuracy);

            if (confidence < 10) {
                conclusionDiv.innerHTML = `
                    <div class="conclusion" style="background: #f8d7da; border-color: #f5c6cb;">
                        <h3 style="color: #721c24;">‚ö†Ô∏è INCONCLUSIVE RESULTS</h3>
                        <p>The accuracy difference is too small (${confidence.toFixed(0)}%). This means either:</p>
                        <ul>
                            <li>Your model needs more training</li>
                            <li>The test images aren't clear enough</li>
                            <li>You need to upload more test images</li>
                        </ul>
                        <p><strong>Recommendation:</strong> Try again with more/clearer images, or retrain your model with better examples.</p>
                    </div>
                `;
            } else if (isInverted) {
                conclusionDiv.innerHTML = `
                    <div class="conclusion" style="background: #fff3cd; border-color: #ffc107;">
                        <h3 style="color: #856404;">üîÑ LABELS ARE INVERTED!</h3>
                        <p>Your training labels were swapped during Teachable Machine training. The model thinks:</p>
                        <ul>
                            <li><strong>Authentic images</strong> ‚Üí Scored as "Replica" (index 1)</li>
                            <li><strong>Replica images</strong> ‚Üí Scored as "Authentic" (index 0)</li>
                        </ul>
                        <p><strong>FIX:</strong> In your app.js, change the prediction line to:</p>
                        <code style="display: block; background: #000; color: #0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            const confidence = predData[1] * 100; // Use index 1 for authentic
                        </code>
                        <p>Confidence: ${confidence.toFixed(0)}% certain</p>
                    </div>
                `;
            } else {
                conclusionDiv.innerHTML = `
                    <div class="conclusion" style="background: #d4edda; border-color: #c3e6cb;">
                        <h3 style="color: #155724;">‚úÖ LABELS ARE CORRECT!</h3>
                        <p>Your model labels are in the correct order:</p>
                        <ul>
                            <li><strong>Index 0</strong> = Authentic ‚úÖ</li>
                            <li><strong>Index 1</strong> = Replica ‚ùå</li>
                        </ul>
                        <p><strong>Your current code is correct:</strong></p>
                        <code style="display: block; background: #000; color: #0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            const confidence = predData[0] * 100; // Use index 0 for authentic
                        </code>
                        <p>Confidence: ${confidence.toFixed(0)}% certain</p>
                    </div>
                `;
            }

            document.getElementById('runTest').disabled = false;
        }
    </script>
</body>
</html>
